{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCET Attendance Portal</title>
    <link rel="icon" href="{% static 'FacultyView/ncet-logo.svg' %}" type="image/svg+xml">
    <link rel="stylesheet" href="{% static 'FacultyView/FV.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const qrCodeImage = document.getElementById('qrCodeImage');
            const qrContainer = document.getElementById('qrContainer');
            const timer = document.getElementById('timer');
            const downloadBtn = document.getElementById('downloadBtn');

            if (sessionStorage.getItem('qrCodeDisplayed')) {
                qrContainer.style.display = 'none';
            } else {
                let timeLeft = 30;
                timer.innerText = `QR Code will disappear in ${timeLeft} seconds`;

                const countdown = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        timer.innerText = `QR Code will disappear in ${timeLeft} seconds`;
                    } else {
                        clearInterval(countdown);
                        qrCodeImage.style.display = 'none';
                        timer.innerText = 'QR Code has disappeared.';
                        sessionStorage.setItem('qrCodeDisplayed', 'true');
                    }
                }, 1000);
            }

            downloadBtn.addEventListener('click', function () {
                const studentList = document.querySelectorAll('.student');
                if (studentList.length === 0) {
                    alert('No students present to download!');
                    return;
                }

                const csvData = [];
                csvData.push(['Student Roll', 'Student Name']);

                for (const student of studentList) {
                    const parts = student.querySelector('.student-name').textContent.split('-');
                    const roll = parts[0].trim();
                    const name = parts.length > 1 ? parts.slice(1).join('-').trim() : ""; //Handles names with hyphens
                    csvData.push([roll, name]);
                }

                const csvContent = csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'attendance.csv';
                link.click();
                URL.revokeObjectURL(link.href);
            });
        });

        function deleteStudent(studentRoll) {
            const studentElement = document.querySelector(`[data-roll="${studentRoll}"]`);
            if (studentElement) {
                studentElement.remove();

                const presentCountElement = document.querySelector('.marked-list h2');
                if (presentCountElement) {
                    let currentCount = parseInt(presentCountElement.textContent.match(/\d+/)[0], 10);
                    if (!isNaN(currentCount) && currentCount > 0) { // Check if parsing was successful
                        presentCountElement.textContent = `Present Count : ${currentCount - 1}`;
                    }
                }
            }
        }
    </script>
    <style>
        #timer {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }

        .attendance-container {
            text-align: center;
            margin: 20px 0;
        }

        .auto-1 button {
            margin: 10px;
        }
    </style>
</head>
<body>
    <section>
        <div style="text-align: center;">
            <img class="ncet-logo" src="{% static 'FacultyView/ncet-logo.svg' %}" alt="logo" width="200" />
        </div>
    </section>
    <header>
        <h1>Canara Engineering College</h1>
        <h4>
            (An Autonomous College under VTU, Accredited by NAAC with “A” Grade) <br />
            Sudhindra Nagara (V), Benajanapadavu (P), Bantwal (T), Dakshina Kannada-574219.
        </h4>
    </header>
    <main>
        <div class="marked-list">
            <h2>Present Count : {{ students|length }}</h2>
            <h3 class="present-list">Present Students</h3>
            <form class="attendance-form" method="POST">
                <ul class="student-list">
                    {% csrf_token %}
                    {% for student in students %}
                    <li class="student" data-roll="{{ student.s_roll }}">
                        <label class="student-label">
                            <span class="student-name">
                                {{ student.s_roll }} - {{ student.s_fname }} {{ student.s_lname }}
                            </span>
                            <button type="button" onclick="deleteStudent('{{ student.s_roll }}')" class="delete-button">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </label>
                    </li>
                    {% endfor %}
                </ul>
            </form>
            <div class="auto-1">
                <a href="{% url 'add_manually' %}"><button>+ Add Manually</button></a>
                <button id="downloadBtn">Download CSV</button> <a href="{% url 'submitted' %}"><button>✔ Submit</button></a>

            </div>
        </div>
        <div class="attendance-container" id="qrContainer">
            <div class="attendance-card">
                <h2>Connect to internet and Scan the QR Code to Mark Attendance</h2>
                <img id="qrCodeImage" src="{% static 'FacultyView/qrcode.png' %}" alt="QR Code" width="200" height="200" />
                <p id="timer" class="hint"></p>
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; QR Attendance System.</p>
    </footer>
</body>
</html>